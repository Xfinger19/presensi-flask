{% extends "base.html" %}

{% block title %}Presensi - Sistem Presensi Digital{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Presensi Karyawan</h1>
    
    <!-- Presensi Form -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Form Presensi</h2>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Pilih Karyawan:</label>
            <select id="selectKaryawan" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="">-- Pilih Karyawan --</option>
                {% for k in karyawan %}
                <option value="{{ k.id }}">{{ k.nama }} - {{ k.divisi }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Status:</label>
            <select id="selectStatus" class="w-full p-3 border border-gray-300 rounded-lg">
                <option value="Hadir">Hadir</option>
                <option value="Izin">Izin</option>
                <option value="Sakit">Sakit</option>
                <option value="Cuti">Cuti</option>
            </select>
        </div>
        
        <div class="mb-4">
            <label class="block text-gray-700 mb-2">Keterangan:</label>
            <textarea id="inputKeterangan" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Optional"></textarea>
        </div>
        
        <div class="flex space-x-4">
            <button onclick="checkIn()" class="flex-1 bg-green-600 text-white py-3 px-6 rounded-lg hover:bg-green-700 transition duration-300 font-semibold">
                <i class="fas fa-sign-in-alt mr-2"></i>Check In
            </button>
            <button onclick="checkOut()" class="flex-1 bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold">
                <i class="fas fa-sign-out-alt mr-2"></i>Check Out
            </button>
        </div>
    </div>
    
    <!-- Status Message -->
    <div id="statusMessage" class="hidden fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50"></div>
    
    <!-- Recent Presensi -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Riwayat Presensi Terbaru</h2>
        <div id="recentPresensi" class="text-gray-500">
            Pilih karyawan untuk melihat riwayat presensi...
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let selectedKaryawanId = null;

document.getElementById('selectKaryawan').addEventListener('change', function(e) {
    selectedKaryawanId = e.target.value;
    if (selectedKaryawanId) {
        loadRecentPresensi(selectedKaryawanId);
    } else {
        document.getElementById('recentPresensi').innerHTML = 'Pilih karyawan untuk melihat riwayat presensi...';
    }
});

function showMessage(message, type = 'success') {
    const statusDiv = document.getElementById('statusMessage');
    statusDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
    }`;
    statusDiv.textContent = message;
    statusDiv.classList.remove('hidden');
    
    setTimeout(() => {
        statusDiv.classList.add('hidden');
    }, 3000);
}

async function checkIn() {
    if (!selectedKaryawanId) {
        showMessage('Pilih karyawan terlebih dahulu!', 'error');
        return;
    }
    
    const data = {
        karyawan_id: selectedKaryawanId,
        status: document.getElementById('selectStatus').value,
        keterangan: document.getElementById('inputKeterangan').value
    };
    
    try {
        const response = await fetch('/api/checkin', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Check-in berhasil!');
            loadRecentPresensi(selectedKaryawanId);
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('Terjadi kesalahan saat check-in', 'error');
    }
}

async function checkOut() {
    if (!selectedKaryawanId) {
        showMessage('Pilih karyawan terlebih dahulu!', 'error');
        return;
    }
    
    const data = {
        karyawan_id: selectedKaryawanId
    };
    
    try {
        const response = await fetch('/api/checkout', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('Check-out berhasil!');
            loadRecentPresensi(selectedKaryawanId);
        } else {
            showMessage(result.message, 'error');
        }
    } catch (error) {
        showMessage('Terjadi kesalahan saat check-out', 'error');
    }
}

async function loadRecentPresensi(karyawanId) {
    try {
        const response = await fetch(`/api/presensi/${karyawanId}`);
        const data = await response.json();
        
        if (data.length === 0) {
            document.getElementById('recentPresensi').innerHTML = '<p class="text-gray-500">Belum ada riwayat presensi.</p>';
            return;
        }
        
        const html = `
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="py-2 px-4 border-b">Tanggal</th>
                            <th class="py-2 px-4 border-b">Waktu Masuk</th>
                            <th class="py-2 px-4 border-b">Waktu Keluar</th>
                            <th class="py-2 px-4 border-b">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-4 border-b">${item.tanggal}</td>
                                <td class="py-2 px-4 border-b">${item.waktu_masuk || '-'}</td>
                                <td class="py-2 px-4 border-b">${item.waktu_keluar || '-'}</td>
                                <td class="py-2 px-4 border-b">
                                    <span class="px-2 py-1 rounded-full text-xs ${
                                        item.status === 'Hadir' ? 'bg-green-100 text-green-800' :
                                        item.status === 'Izin' ? 'bg-blue-100 text-blue-800' :
                                        item.status === 'Sakit' ? 'bg-orange-100 text-orange-800' :
                                        'bg-gray-100 text-gray-800'
                                    }">${item.status}</span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        document.getElementById('recentPresensi').innerHTML = html;
    } catch (error) {
        console.error('Error loading presensi:', error);
    }
}
</script>
{% endblock %}